powered by 35's Embedded Systems Inc. A Next generation Driver Solution for Portable Laser Emitter                                                                                                                        

### 概述

Xtern Ripper Laser Edition(简称XTRLaser)是专用于驱动日亚LD BANK **（例如NUBB23、NUBB33以及NUBB27、NUBB37等）** 的高能效侧按电子开关控制的升压恒流驱动器。该驱动器具备自适应功能，同时支持单锂和双锂输入并自动适配采用最合适的功率驱动激光模组。该驱动的尺寸为22mm，高度7mm，可以完美兼容东东海D2GC或M0AC等22mm驱动位的侧按小直外壳。在M0AC小直内搭配日亚NUBB23模块时可以实现高达31W的峰值光功率并且稳定运行至温度保护激活。是实现小体积暴脾气亮骚烧东西激光小直的专用解决方案。相比市面上基于LED手电筒驱动的魔改产物具有更高的耐压 **（例如那些用双锂MP341升压做的LD驱动，芯片容许的最高输出电压为16V然后激光模块的Vf高达15.98V，顶着芯片耐压极限跑就不怕炸么）** 和稳定性以及更适配的温度保护和操作逻辑。

### 性能数据

+ 支持的电池输入类型：1S至2S的三元锂电池组，内阻需小于50mΩ且额定放电能力大于等于15A。 **注意：驱动在1S模式下将会自动限制输出功率至约30W避免IC过载，但是此时仍然需要使用全极耳类型的低内阻动力电池。如果需要获得完整的使用体验，请搭配2S电池组使用！**
+ 支持的LD Bank类型：（单/双锂）NUBB13、NUBB23、NUBB33 **NUBB27和NUBB37硬件理论支持，但是需要调整参数，目前暂未有条件测试** 。（仅单锂并搭配特定固件和硬件）NURM11T
+ 支持的LD电流：150mA至4.1A（适配单管多串LD）
+ 温度保护：46度PI环自适应外壳恒温（温控启动后驱动根据外壳散热能力和环境自动调整亮度达到最高可实现的亮度）+55度极亮cutoff+65度强制关机
+ 电池保护：具有欠压自动降档和关机保护以及过电压保护
+ 输出保护：具备LD开路和短路检测

### 基本功能操作逻辑

+ 调焦挡位：关机状态下单击+长按进入。该挡位下驱动会令LD在远低于其阈值电流的条件下运行输出无害的弱光用于进行光学系统测试或者对焦以及瞄准工作（也可以拿来逗猫玩 *笑）。该挡位下用户可以单击关闭，若长按则会进入到循环挡位模式的最低挡位。
+ 循环挡位模式：关机状态下单击进入。首次上电时驱动默认位于最低挡位，长按在`低->中->中高->高`四个挡位内反复循环切换。单击+长按则逆向按照`高->中高->中->低`的顺序逐步降到最低并在最低挡位停止，单击关闭。**注意：如果驱动被配置为单锂电模式，则驱动的高挡位将会被禁用，此时循环只剩下：低、中和中高挡位。**
+ 无极调光模式：关机状态下长按进入。该挡位允许用户在0.55A至3A（对应1.2-22W光功率）的范围内无极调整并选定一个指定的亮度挡位（如果驱动工作在单锂模式，则调节范围将会被限制为0.55-1.8A对于1.2-12W光功率）。进入该挡位后长按升高亮度，单击+长按减少亮度。若亮度达到最高或最低时驱动会令LD慢闪提示您亮度调整已经达到限制。若要回到关机状态，则单击开关一次。 **注：该挡位的亮度数据具有永久性记忆，设定好亮度后约3秒系统会永久保存至存储器内，即使断电也不会丢失。**
+ 极亮挡位：在驱动处于双锂电模式且安装了两节电池时生效，如果您只安装了一节电池，则双击会进入到循环挡位中的中高档此时仍然能一键最高功率但是无法开启正常极亮的全功率。在任意状态下双击则驱动开启最高输出功率模式。此时驱动将会以全功率输出并实现约31W的光功率。 **该挡位发热巨大且输出功率极高，为了避免引起火灾请务必小心使用！**
+ 特殊功能挡位：关机状态下三击进入，长按在`SOS->呼吸巡航灯->周期频闪信标灯`这三种特殊模式内按顺序循环切换。单击+长按则逆序循环切换。单击回到关机状态。对于这三个特殊功能挡位的具体功能则如下所示：
  - SOS：驱动令LD以0.8A电流点亮播报国际标准SOS求救信号（三短三长三短）并反复循环。每次播报结束后会停顿三秒再继续。
  - 呼吸巡航灯：驱动令LD工作在呼吸闪状态（亮度从低缓升最高后又缓降到最低，到最低后熄灭并停顿三秒后再次从最低亮度缓升并反复循环）
  - 周期频闪信标灯：进入后驱动首先以低亮度点亮LD约2秒提醒用户已经进入该模式。然后驱动每隔3秒令LD以额定功率短时间脉冲工作（约50mS）后立即关闭并进入休眠，3秒后再次启动输出脉冲并反复循环。 
+ 一键烧灼模式：关机状态下四击开关，此时驱动以远低于激光管阈值电流的最低功率点亮输出无害的弱光方便用户进行瞄准，按住开关则驱动立即以全功率工作（此时约30W光功率，如果驱动工作在单锂模式则限制为约12W）进行烧灼，松开则回到低功率状态。若用户单击则回到关闭状态。该挡位具备超时和过温保护功能。若驱动电量不足或超过1分钟未操作，以及驱动发生过热事件，则会自动关机。
+ 按键锁：关机状态下五击开关，侧按指示灯红色闪三次进入锁定模式。进入锁定模式后，除了单击+长按临时开启几乎无害的低功率激光输出，松开手自动熄灭或开启20秒后自动熄灭以外（模拟人畜无害的低功率沙盘指星笔的行为，用于骗过安检），其余任何操作均会被驱动忽略并使用红色快闪5次提示用户。**为了保证安全，进入锁定模式后即使重新安装电池，激光手电也会始终保持在锁定状态。** 在锁定状态下再次五击，侧按指示灯绿色闪烁三次，并且LD以低功率点亮0.5秒表示成功解锁，此时驱动回到正常操作模式可以正常操作。

### 特殊功能操作逻辑

+ 应急求救挡位：关机状态下五击+长按进入，驱动令LD以0.6A电流点亮播报国际标准SOS求救信号（三短三长三短）并反复循环。每次播报结束后会停顿三秒再继续。该挡位只要电池在静置状态下电压高于2.5V就会持续运行并一直发送信号，可以让用户在紧急情况下以报废电池的小小代价持续的发射求救信号并获得一线生机。 **对于非紧急状态不建议使用该挡位，以免电池过度放电并永久损毁。**
+ 重置无极调光亮度：在关机状态下四击+长按，驱动将会重置无极调光亮度至最低值并进入无极调光模式，其余操作请参考基本功能章节内的无极调光操作指引。
+ 固件编译时间戳查询：关机状态下8击进入。进入后驱动将会令LD点亮1秒，提示即将开始播报。然后驱动将会按顺序播报固件编译的年份、月份，日期以及编译时的时间（精确到分钟）。首先驱动会播报固件编译的具体日期，播报会分为三组数字，每组数字之间停顿2.5秒，同一组数字之间会有1.5秒的间隔方便用户区分。在播报完第一到第三组数字所表示的驱动编译固件编译的年份、月份，日期之后，驱动将会停顿4.5秒然后开始播报固件编译的具体时间（精确到分钟）。具体编译时间的播报会分为两组数字，每组数字之间停顿2.5秒，同一组数字之间会有1.5秒的间隔方便用户区分。**需要注意的是，播报启动后就无法中断，在版本信息播报过程中，驱动将不响应任何操作，直到播报结束。** 详细的播报规则如下：
 
  - 第一组数字：指示固件编译的年份。其中LD慢速闪烁N次表示非零的数字，如果快速闪烁一次，则表示该数据位为0。两位数字之间系统会停顿1.5秒。例如`慢闪2次-停顿1.5秒-慢闪5次`表示固件编译的年份为**25（2025年）**。
  - 第二组数字：指示固件编译的月份。其中LD慢速闪烁N次表示非零的数字，如果快速闪烁一次，则表示该数据位为0。两位数字之间系统会停顿1.5秒。例如`快闪1次-停顿1.5秒-慢闪9次`表示固件编译的月份为**09（9月）**。
  - 第三组数字：指示固件编译的具体日期（精确到天）。其中LD慢速闪烁N次表示非零的数字，如果快速闪烁一次，则表示该数据位为0。两位数字之间系统会停顿1.5秒。例如`慢闪3次-停顿1.5秒-快闪1次`表示固件编译的具体日期为**30日**。
  - 第四组数字：以24小时制度指示固件编译时间的小时部分。其中LD慢速闪烁N次表示非零的数字，如果快速闪烁一次，则表示该数据位为0。两位数字之间系统会停顿1.5秒。例如`慢闪1次-停顿1.5秒-慢闪3次`表示固件编译的时间（小时）为**13时（下午1点）**。
  - 第五组数字：指示固件编译时间的分钟部分。其中LD慢速闪烁N次表示非零的数字，如果快速闪烁一次，则表示该数据位为0。两位数字之间系统会停顿1.5秒。例如`慢闪4次-停顿1.5秒-慢闪6次`表示固件编译的时间（分钟）为**46分**。

+ 设置按键有源夜光功能：关机状态下七击按键，驱动令侧按指示灯以绿色快闪一次表示功能开启。若以红色快闪一次则表示功能关闭。该功能开启后，驱动将会在闲置未用且电池电压充足的情况下令按键发出微弱绿光指示激光手电的开关位置，方便用户在全黑环境中进行操作。
+ 温度查询模式：驱动任意状态下三击+长按进入。当进入温度查询模式后激光手电的颈部开关指示灯首先将会以红黄绿依次点亮的方式（**若激光手电当前处于极寒环境使得驱动本身的温度低于0摄氏度时，先导提示将变为绿黄红的顺序**）作为先导提示，提示用户手电即将开始显示当前的内部温度（由驱动的内置的NTC热敏电阻测得）。延迟1秒后驱动将通过红色和黄色的指定次数的慢速闪烁（如果快速闪烁一次，则表示该数据位为0）提示用户当前的驱动温度。在播报完当前驱动的温度数值后，驱动将会在延迟2秒后通过后续的长亮(或者慢闪)提示用户当前驱动的具体温度值所对应的手电整体散热情况。对于温度显示的计算方式请参考如下内容：

  - 播报完毕后绿色常亮：当前手电散热良好，内部温度正常
  - 播报完毕后黄色常亮：当前手电内部温度较高，请注意防止烫手
  - 播报完毕后红色常亮：当前手电内部温度温度极高，请及时为手电散热并且避免被烫伤   
  - 驱动温度(℃)=红色闪烁次数x10+黄色闪烁次数，例如`红色慢闪4次-黄色快闪1次`表示当前驱动所测到的内部温度为40℃

+ 电池电压和电量查询功能：驱动任意状态下通过双击+长按进入。当进入电量查询模式后手电的颈部开关指示灯首先将会以红黄绿依次点亮的方式（**若电池电压低于10.00V，则系统将会切换到高精度显示模式以0.01V精度显示电量。此时先导提示将变为绿黄红的顺序**）作为先导提示，提示用户驱动即将开始显示电池电压和电量。延迟1秒后驱动将通过红色，黄色和绿色的指定次数的慢速闪烁（如果快速闪烁一次，则表示该数据位为0）提示用户当前的电池电压，播报完电池当前电压后，驱动将会在延迟2秒后通过后续的长亮(或者慢闪)提示用户当前电池电压对应的总体电量水平（指示方式参考下文中驱动位于正常工作时的指示），对于电池具体电压播报的计算方式请参考如下内容：
  
  -  99.9V显示模式：红色闪烁次数x10+黄色闪烁次数+绿色闪烁次数x0.1=当前电池电压(V)，例如`红色慢闪1次-黄色快闪1次-绿色慢闪4次`表示电池电压为10x1+0+4x0.1=10.4V。
  -  9.99V高精度显示模式：红色闪烁次数+黄色闪烁次数x0.1+绿色闪烁次数x0.01=当前电池电压(V)，例如`红色慢闪8次-黄色慢闪1次-绿色慢闪3次`表示电池电压为8+1*0.1+3x0.01=8.13V。

+ 恢复出厂设置：在驱动处于完全断电状态下（用户可以通过卸下电池并反复多次按下手电的侧按按钮直到手电没有任何反应）持续按住按钮并扭上电池包令驱动通电。此时驱动的侧部按键指示灯将会以黄色的持续高频率快闪提示用户已恢复出厂设置。用户松开按键后，驱动将会在2秒后自动重启并进入正常工作状态。

### 正常工作时的电量指示

对于电压指示，驱动在正常挡位的工作状态会通过指示灯点亮的方式提示用户当前系统的电池电量（如果驱动当前处于无保护的SOS应急求生挡位，则驱动的电量指示灯会改为每5秒短暂点亮一次以节约电力消耗）。与此同时，在驱动首次装入电池时，驱动还会通过一次持续2秒的点亮提示电池电量（指示方式和工作状态时相同）。对于驱动当前的电量状态和对应的指示灯状态请参考如下内容：

  - 绿色常亮：电池电量充足
  - 黄色常亮：电池电量较为充足
  - 红色常亮：电池电量不足，请尽快为电池充电
  - 红色慢闪：电池电量严重不足，请立即为电池充电（此时驱动的功能将会被限制）

与此同时，在驱动正常工作时，驱动还会再某些特定事件发生时通过一定时间内的短时间熄灭次数的循环指示驱动发生的事件，详细的事件列表如下：

  + 每2秒瞬时熄灭1次：驱动检测到外壳温度过高，驱动已启用温控限制驱动输出功率避免LD过热光衰

### 电池参数配置

该激光驱动同时支持单锂和双锂电的操作，驱动可以自动检测双锂电的插入并切换为双锂电池模式，驱动在单锂电模式下仍然可以工作但是部分功能将会被限制以避免电池过载，为了得到最佳的使用体验建议安装两节电池。对于电池配置模式用户也可以随时进行手动调整。对于如何确认系统当前的电池配置以及调整配置等，请参考如下内容：

+ 识别系统当前的电池配置：在每次装入电池时，电量指示灯会进行自检并显示当前电池电量。如果当前系统开启了双锂电模式，则系统在装入电池后首先会以黄色快闪2次，延迟0.5秒后再显示电池电量（假设电量充足，则指示灯将绿色常亮3秒）。若当前为单锂模式，则驱动将会直接提示电池电量。
+ 双锂电自动识别功能：当系统处于单锂电模式时，如果用户装入两节电池，则系统会检测到并自动切换至双锂模式。此时系统会通过令侧按指示灯绿色快速频闪2次作为检测到双锂的提示。此时驱动将会自动切换到双锂状态。
+ 切换单锂/双锂模式：对于非红光模式的固件，用户可以通过在关机状态下六击侧按切换单锂和双锂模式。当切换为单锂模式时，激光手电的侧按将会通过红色频闪一次提示已经成功切换。如果是切换为双锂模式，则激光手电的侧按将会通过绿色频闪2次提示成功切换。**需要注意的是，如果系统当前安装了2节电池，为了保护电池避免过度放电，此时系统将会禁止用户切换为单节锂电池模式。如果您需要从双锂模式切换至单锂模式，请将电池取出并仅安装一节电池，再进行切换操作。**

### LD模式选择

该固件的源码支持多种不同的LD模块。用户在编译时需要在工程的宏定义中指定LD的类型，否则编译无法通过。目前该固件支持的LD列表可以参考如下内容。如果您需要针对特定型号的LD进行适配，则请自行测试或提供LD样品给作者并进行标定。

+ NUBB13/NUBB23/NUBB33:单发光体四串四光束蓝光模组，可以直接使用。编译时使用`USING_LD_NUBB33`宏。
+ NUBB14/NUBB24/NUBB34:双发光体四串八光束蓝光模组，里面实际上等效于两个NUBB13/NUBB23/NUBB33模块安装在同一个基板，可以把单管拆下来使用。编译时使用`USING_LD_NUBB33`宏。
+ NUBB27/NUBB37:单发光体五串五光束蓝光模组，需要搭配硬件调整方可使用。编译时使用`USING_LD_NUBB37`宏。
+ NUBB28T/NUBB38:双发光体五串十光束蓝光模组，里面实际上等效于两个NUBB27/NUBB37模块安装在同一个基板，可以把单管拆下来并搭配硬件调整使用。编译时使用`USING_LD_NUBB37`宏。
+ NURM11T：单发光体四串四光束蓝光模组，可以直接使用， **但是该模组因工作电压较低，仅支持单锂模式且需要对硬件进行调整！** 编译时使用`USING_LD_NURM11T`宏。

### 编译固件时MCU的CONFIG配置

由于中微单片机内部有一组硬编码于Flash指定区域，用于设置单片机的硬件首选项（例如看门狗，调试模式，低电压保护点等）的配置Word。为了确保编译出来的固件可以在硬件内正常运行，您需要在工程配置(Options for Target 'XTRLaser'->Debug选项卡->右上角的Settings按钮)的Config设置菜单，按照下表正确填写MCU的配置。错误的CONFIG设置会引起固件工作异常！

+ Power                      :  Inter 3.3V            
+ WDT                        :  SOFTWARECONTROL     
+ PROTECT                    :  ENABLE              
+ FLASH_DATA_PROTECT         :  ENABLE              
+ LVR                        :  1.8V                
+ DEBUG                      :  Disable             
+ OSC                        :  HSI                 
+ OSC_PRESCALE               :  Fosc/1              
+ HSI_FS                     :  Fhsi/1              
+ EXT_RESET                  :  DISABLE             
+ EXT_RESETSEL               :  P00                 
+ WAKEUP_WAITTIME            :  500us               
+ CPU_WAITCLOCK              :  2T                  
+ WRITE_PROTECT[0-2K]        :  DISABLE             
+ WRITE_PROTECT[2-4K]        :  DISABLE             
+ WRITE_PROTECT[4-6K]        :  DISABLE             
+ WRITE_PROTECT[6-8K]        :  DISABLE             
+ WRITE_PROTECT[8-10K]       :  DISABLE             
+ WRITE_PROTECT[10-12K]      :  DISABLE             
+ WRITE_PROTECT[12-14K]      :  DISABLE             
+ WRITE_PROTECT[14-16K]      :  DISABLE             
+ BOOT                       :  BOOT_DIS 

### 运行时错误监测和错误ID汇报

该驱动具备错误监视系统，如果在运行期间如果驱动检测到无法解决的致命问题则会进入保护模式避免驱动和昂贵的激光二极管损毁，并通过颈部侧按键的指示灯提示用户发生的错误类型。每个指示循环首先以红黄绿的颜色切换闪烁开始，然后通过紧跟着的红色慢闪次数指示错误ID号，慢闪结束后会停顿一会并重新开始循环，对于ID号所对应的错误描述请参考如下内容：

+ 闪烁1次(Fault_DCDCFailedToStart) 驱动在尝试启动DCDC时失败。检查驱动输出正极是否对外壳短路，DCDC芯片的使能信号和内部LDO输出电压是否正常。
+ 闪烁2次(Fault_DCDCShort) 驱动在运行时检测到输出短路。
+ 闪烁3次(Fault_InputOVP) 驱动检测到输入电压过高，请检测驱动的电池配置是否和使用的电池配套。
+ 闪烁4次(Fault_DCDCOpen) 驱动在运行时检测到输出空载，请检查LED是否损坏。
+ 闪烁5次(Fault_NTCFailed) 驱动在运行期间检测到测量驱动温度的热敏电阻出现异常，检查热敏电阻和测温部分的上拉电阻是否损坏。
+ 闪烁6次(Fault_OverHeat) 驱动检测到外壳温度过高，请等待手电冷却。冷却后故障会自动解除

----------------------------------------------------------------------------------------------------------------------------------
© redstoner_35 @ 35's Embedded Systems Inc.  2025